networks:
  internal_net:
    driver: bridge
    internal: true
  external_net:
    driver: bridge
    # Enable if a an external reverse proxy is used
    # external: true  
  proxy_net:
    driver: bridge
    internal: true

secrets:
  license_key:
    file: ./secrets/license_key
  platform_admin_password:
    file: ./secrets/platform_admin_password
  db_password:
    file: ./secrets/db_password
  encryption_key:
    file: ./secrets/encryption_key
  smtp_server_password:
    file: ./secrets/smtp_server_password
  # gemini_api_key:
  #   file: ./secrets/gemini_api_key
  # ollama_api_key:
  #   file: ./secrets/ollama_api_key
  # microsoft_client_secret:
  #   file: ./secrets/microsoft_client_secret
  # google_client_secret:
  #   file: ./secrets/google_client_secret

volumes:
  data:
    name: DataSpace_data
    driver: local
    driver_opts:
      type: none
      device: ./volume/DataSpace_data
      o: bind
  db_data:
    name: DataSpace_db_data
    driver: local
    driver_opts:
      type: none
      device: ./volume/DataSpace_db_data
      o: bind
  db_backup:
    name: DataSpace_db_backup
    driver: local
    driver_opts:
      type: none
      device: ./volume/DataSpace_db_backup
      o: bind
  ollama_data:
    name: DataSpace_ollama_data
  caddy_data:
    name: DataSpace_caddy_data
  host_metrics:
    name: DataSpace_host_metrics
    driver: local
    driver_opts:
      type: none
      device: ./metrics/host_metrics
      o: bind

services:

  database:
    image: postgres:15
    container_name: DataSpace_database
    environment:
      - POSTGRES_DB=DataSpace
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    expose:
      - '5432'
    restart: always
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - internal_net
    shm_size: 1g
    secrets:
      - db_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 2s
      timeout: 5s
      retries: 15



  pgbackups:
    image: prodrigestivill/postgres-backup-local
    container_name: DataSpace_pgbackups
    restart: always
    volumes:
      - db_backup:/backups
    depends_on:
      database:
        condition: service_healthy
    environment:
      - POSTGRES_HOST=${DB_SERVER}
      - POSTGRES_DB=DataSpace
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - SCHEDULE=@daily
      - BACKUP_KEEP_DAYS=7
      - BACKUP_KEEP_WEEKS=4
      - BACKUP_KEEP_MONTHS=6
      - HEALTHCHECK_PORT=8080
    networks:
      - internal_net
    secrets:
      - db_password
    


  docker-socket-proxy:
    image: wollomatic/socket-proxy:1
    container_name: DataSpace_docker_socket_proxy
    restart: always
    user: "0:0"  
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges
    environment:
      - SP_ALLOWFROM=0.0.0.0/0
      - SP_LISTENIP=0.0.0.0
      - SP_PROXYPORT=2375
      - SP_LOGLEVEL=info
      - SP_ALLOW_GET=(/images/json)
      - SP_ALLOW_POST=(/containers/create|/containers/.*/start|/containers/.*/wait|/containers/.*/stop|/build)
      - SP_ALLOWHEALTHCHECK=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - proxy_net

  api:
    image: ghcr.io/dataspaceswiss/api:${API_VERSION:-latest}
    container_name: DataSpace_api
    depends_on:
      database:
        condition: service_healthy
    environment:
      - AppSettings__INSTANCE_NAME=${INSTANCE_NAME}
      - AppSettings__INSTANCE_COLOR=${INSTANCE_COLOR}
      - AppSettings__CORS_ORIGINS=${CORS_ORIGINS}
      - AppSettings__API_URL=${API_URL}
      - AppSettings__SMTP_SERVER=${SMTP_SERVER}
      - AppSettings__SMTP_USER=${SMTP_USER}
      - AppSettings__SMTP_DOMAIN=${SMTP_DOMAIN}
      - AppSettings__OLLAMA_ENDPOINT=${OLLAMA_ENDPOINT}
      - AppSettings__DATAASSISTANT_DEFAULT_MODEL=${DATAASSISTANT_DEFAULT_MODEL}
      - AppSettings__DATAASSISTANT_MAX_ITERATIONS=${DATAASSISTANT_MAX_ITERATIONS}
      - AppSettings__CODINGASSISTANT_DEFAULT_MODEL=${CODINGASSISTANT_DEFAULT_MODEL}
      - AppSettings__GEMINI_ENDPOINT=${GEMINI_ENDPOINT}
      - AppSettings__DOCKER_HOST=http://docker-socket-proxy:2375
      - AppSettings__DATA_STORAGE_PATH=${DATA_STORAGE_PATH}
      - AppSettings__HOST_DATA_STORAGE_PATH=${HOST_DATA_STORAGE_PATH}
      - AppSettings__HOST_METRICS_PATH=${HOST_METRICS_PATH}
      - AppSettings__PLATFORM_ADMIN_EMAIL=${PLATFORM_ADMIN_EMAIL}
      - AppSettings__DB_SERVER=${DB_SERVER}
      - AppSettings__MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - AppSettings__GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - AppSettings__USER_ID=${USER_ID}
      - AppSettings__GROUP_ID=${GROUP_ID}
      # - AppSettings__MAX_BUILD_RETENTION_COUNT=10
      # - AppSettings__MAX_SCHEDULE_FAIL_COUNT=3
      # - AppSettings__MAX_BUILD_RUNNER_COUNT=4
      # - AppSettings__MAX_TIMEOUT_HOURS=8
      - ASPNETCORE_URLS=http://+:5010
      - HEALTHCHECK_PORT=5010
    expose:
      - '5010'
    restart: always
    volumes:
      - data:/app/data
      - host_metrics:/metrics/host_metrics:ro
    networks:
      - external_net
      - internal_net
      - proxy_net
    user: "${USER_ID}:${GROUP_ID}"
    secrets:
      - license_key
      - platform_admin_password
      - smtp_server_password
      - db_password
      - encryption_key
      # - gemini_api_key
      # - ollama_api_key
      # - microsoft_client_secret
      # - google_client_secret
    deploy:
      resources:
        reservations:
          cpus: '0.25'
          memory: 64M

  ollama:
    image: ghcr.io/dataspaceswiss/ollama:${OLLAMA_VERSION:-latest}
    container_name: DataSpace_ollama
    expose:
      - '11434'
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - internal_net
      - external_net # Ollama needs external network to download models


  frontend:
    image: ghcr.io/dataspaceswiss/frontend:${FRONTEND_VERSION:-latest}
    container_name: DataSpace_frontend
    depends_on:
      - api
    environment:
      - API_URL=${API_URL}
      - INSTANCE_NAME=${INSTANCE_NAME}
      - INSTANCE_COLOR=${INSTANCE_COLOR}
    expose:
      - '80'
    restart: always
    networks:
      - external_net
    deploy:
      resources:
        reservations:
          cpus: '0.125'
          memory: 10M

  caddy:
    image: caddy:latest
    container_name: DataSpace_caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./caddy/blocked_ips.caddyfile:/etc/caddy/blocked_ips.caddyfile
      - caddy_data:/data
    networks:
      - external_net
    deploy:
      resources:
        reservations:
          cpus: '0.25'
          memory: 20M
